{
  "id": "EOJfPcM9PPWI1Rmp",
  "meta": {
    "instanceId": "3aaeb6eaba3494bbdbe57e25fa3d02783cfbc460b1e823f7b741cf26edc7ca3d",
    "templateCredsSetupCompleted": true
  },
  "name": "G√©n√©ration automatis√©e de rapports de recherche avec OpenAI, Wikipedia, Google Search, et Gmail/Telegram",
  "tags": [
    {
      "id": "1",
      "name": "Audelalia"
    }
  ],
  "nodes": [
    {
      "id": "46c09535-cd6b-481c-b520-67ecb4aad812",
      "name": "Mod√®le de chat OpenAI",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        776,
        -100
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "WLM64KJjQFXGWGWi",
          "name": "OpenAi account N8N"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "574ec863-e557-4196-b1b9-5c275a7de73a",
      "name": "M√©moire simple",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        896,
        -100
      ],
      "parameters": {
        "sessionKey": "={{ $json.output.searchQueries }}",
        "sessionIdType": "customKey"
      },
      "typeVersion": 1.3
    },
    {
      "id": "661349c2-7bb1-4c95-af8f-3a108a619c84",
      "name": "Rechercher des actualit√©s",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "position": [
        1016,
        -100
      ],
      "parameters": {
        "url": "=https://newsapi.org/v2/everything?q={{ encodeURIComponent($input.cleanedQuery) }}&apiKey=\"YOURAPIKEY\"",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "q"
            },
            {
              "name": "pageSize",
              "value": "3",
              "valueProvider": "fieldValue"
            },
            {
              "name": "sortBy",
              "value": "publishedAt",
              "valueProvider": "fieldValue"
            },
            {
              "name": "language",
              "value": "en",
              "valueProvider": "fieldValue"
            }
          ]
        },
        "toolDescription": "R√©cup√®re des articles d'actualit√© r√©cents",
        "optimizeResponse": true
      },
      "typeVersion": 1.1
    },
    {
      "id": "6d43251f-db88-45fa-be65-de368d4db408",
      "name": "Wikipedia",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "position": [
        1136,
        -100
      ],
      "parameters": {
        "url": "=https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro&explaintext&titles={{ $input.query ? encodeURIComponent($input.query) : encodeURIComponent($json.refined_query) }}\n\n",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "action",
              "valueProvider": "modelOptional"
            },
            {
              "name": "prop",
              "value": "extracts",
              "valueProvider": "fieldValue"
            }
          ]
        },
        "toolDescription": "R√©cup√®re des donn√©es structur√©es depuis Wikipedia",
        "optimizeResponse": true
      },
      "typeVersion": 1.1
    },
    {
      "id": "c94b1446-82bf-47c8-8f5d-c5da9a43a7e7",
      "name": "Mod√®le de chat OpenAI1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        380,
        -80
      ],
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "credentials": {
        "openAiApi": {
          "id": "WLM64KJjQFXGWGWi",
          "name": "OpenAi account N8N"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "834efc04-b05f-4ddc-a8d9-b93d9c4e099a",
      "name": "Affinage de requ√™te",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        400,
        -320
      ],
      "parameters": {
        "text": "=Vous √™tes un expert en g√©n√©ration de requ√™tes. Sur la base de la requ√™te affin√©e fournie, g√©n√©rez exactement 5 requ√™tes de recherche connexes qui peuvent aider √† √©largir le champ de recherche. Chaque requ√™te doit se concentrer sur un aspect diff√©rent du sujet (par exemple, applications, d√©fis, d√©veloppements r√©cents, domaines sp√©cifiques, √©tudes de cas). La sortie doit correspondre au sch√©ma JSON suivant :\n{\n  \"topic\": \"La requ√™te affin√©e\",\n  \"searchQueries\": [\"requ√™te1\", \"requ√™te2\", \"requ√™te3\", \"requ√™te4\", \"requ√™te5\"]\n}\n\nRequ√™te affin√©e : {{ $json.cleanedQuery}}\nExemples :\n- Requ√™te affin√©e : \"tendances actuelles en intelligence artificielle 2025\"\n  Sortie : {\n    \"topic\": \"tendances actuelles en intelligence artificielle 2025\",\n    \"searchQueries\": [\n      \"applications de l'IA en sant√© 2025\",\n      \"d√©fis √©thiques de l'intelligence artificielle 2025\",\n      \"d√©veloppements r√©cents en IA g√©n√©rative 2025\",\n      \"tendances de l'IA dans l'√©ducation 2025\",\n      \"tendances de financement des startups IA 2025\"\n    ]\n  }\n- Requ√™te affin√©e : \"applications de l'intelligence artificielle dans le diagnostic et le traitement en sant√©\"\n  Sortie : {\n    \"topic\": \"applications de l'intelligence artificielle dans le diagnostic et le traitement en sant√©\",\n    \"searchQueries\": [\n      \"IA dans le diagnostic m√©dical 2025\",\n      \"intelligence artificielle pour les plans de traitement personnalis√©s\",\n      \"d√©fis de l'IA dans le diagnostic en sant√©\",\n      \"√©tudes r√©centes sur l'IA en sant√©\",\n      \"√©tudes de cas sur le diagnostic en sant√© par IA\"\n    ]\n  }",
        "options": {},
        "promptType": "define",
        "hasOutputParser": true
      },
      "typeVersion": 1.8
    },
    {
      "id": "1f83e2d8-23ee-46e2-998a-b644ea0fff3c",
      "name": "Agent IA de recherche",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        900,
        -320
      ],
      "parameters": {
        "text": "=Effectuer des recherches sur le sujet \n\"{{ $json.output.topic }}\"\n\n\nen utilisant les requ√™tes de recherche suivantes : {{ $json.output.searchQueries.join(\",\") }}\n\n",
        "options": {
          "systemMessage": "=Vous √™tes un assistant de recherche nomm√© \"ResearchBot\". Votre r√¥le est de r√©aliser des recherches approfondies et compl√®tes bas√©es sur le sujet et les requ√™tes de recherche fournies.\n\nSuivez ces √©tapes pour recueillir des donn√©es :\n- Recherchez sur le web des informations g√©n√©rales en utilisant le sujet et les requ√™tes fournies, en vous concentrant sur les tendances, d√©veloppements et applications r√©cents (2024-2025).\n- Recherchez sur Wikipedia des connaissances fondamentales sur le sujet afin de fournir un contexte.\n- Recherchez des articles d'actualit√© r√©cents (de 2024 √† 2025) pour identifier les d√©veloppements, annonces et tendances actuels.\n- Recherchez sur Google Scholar des articles acad√©miques (de 2020 √† 2025) pour collecter des perspectives savantes et des r√©sultats de recherche.\n- R√©sumez et agr√©gez toutes les d√©couvertes dans un format JSON structur√©.\n- Assurez-vous que toutes les donn√©es sont directement pertinentes au sujet :  {{ $json.output.topic }}.\nRetournez les r√©sultats de la recherche sous forme d'objet JSON brut avec la structure suivante :\n{\n  \"introduction\" : \"Une introduction d√©taill√©e de 4 √† 6 phrases sur le sujet, fournissant contexte, importance et un bref aper√ßu des tendances actuelles.\",\n  \"summary\" : \"Un r√©sum√© complet de 6 √† 8 phrases des principales conclusions, couvrant les tendances, d√©fis, opportunit√©s et applications notables.\",\n  \"key_findings\" : [\"Une liste de 8 √† 12 points cl√©s ou tendances sp√©cifiques, chacun sous forme de phrase concise.\" \n\nCela doit toujours √™tre un tableau avec au moins 8 √©l√©ments.\"],\n  \"news_highlights\": [\"Une liste de 4 √† 6 titres d'actualit√©s r√©centes avec leurs sources (de 2024 √† 2025), chacun au format 'Titre - Source, Ann√©e'. Cela doit toujours √™tre un tableau avec au moins 4 √©l√©ments.\"],\n  \"scholarly_insights\": [\"Une liste de 4 √† 6 analyses issues d'articles acad√©miques avec leurs sources (de 2020 √† 2025), chacune au format 'Analyse (Auteur et al., Ann√©e, Journal)'.\\\n\nCela doit toujours √™tre un tableau contenant au moins 4 √©l√©ments.\"],\n  \"wikipedia_summary\": \"Un r√©sum√© d√©taill√© de 4 √† 6 phrases des connaissances fondamentales tir√©es de Wikipedia, fournissant le contexte historique et de fond sur le sujet.\",\n  \"sources\": [\"Une liste de toutes les URLs sources (au moins 8 √† 12 sources uniques et pertinentes, incluant des articles web, des actualit√©s et des publications acad√©miques).\\\n\nCela doit toujours √™tre un tableau contenant au moins 8 √©l√©ments.\"]\n}\nSi les donn√©es sont insuffisantes pour un champ quelconque, effectuez des recherches suppl√©mentaires en utilisant des variations du sujet et des requ√™tes afin de satisfaire aux exigences minimales.\n\nPar exemple :\n\nRetourner uniquement l'objet JSON brut.. \nSujet : {{ $json.output.topic }}\nRequ√™tes de recherche : {{ $json.output.searchQueries }}"
        },
        "promptType": "define"
      },
      "typeVersion": 1.8
    },
    {
      "id": "a53cfaac-425a-4558-a661-1042cb63599d",
      "name": "Recherche Google Web",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "position": [
        1256,
        -100
      ],
      "parameters": {
        "url": "=https://www.googleapis.com/customsearch/v1?key=\"YOURAPIKEY\"={{ encodeURIComponent($input.query) }}",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "num",
              "value": "5",
              "valueProvider": "fieldValue"
            }
          ]
        },
        "toolDescription": "Recherche sur le web une requ√™te donn√©e en utilisant l'API Google Custom Search",
        "optimizeResponse": true
      },
      "typeVersion": 1.1
    },
    {
      "id": "27548bf6-7f86-4e38-befb-3ad55c4d6c46",
      "name": "SerpApi",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "position": [
        1376,
        -100
      ],
      "parameters": {
        "url": "=https://serpapi.com/search?engine=google_scholar&q={{ encodeURIComponent( $json.refined_query ) }}&api_key=\"YOURAPIKEY\"",
        "sendQuery": true,
        "authentication": "predefinedCredentialType",
        "parametersQuery": {
          "values": [
            {
              "name": "num",
              "value": "3",
              "valueProvider": "fieldValue"
            }
          ]
        },
        "toolDescription": "Recherche des articles acad√©miques sur Google Scholar",
        "optimizeResponse": true,
        "nodeCredentialType": "serpApi"
      },
      "credentials": {
        "serpApi": {
          "id": "9LoJ3XtPiLBGUI5W",
          "name": "SerpAPI account"
        }
      },
      "typeVersion": 1.1
    },
    {
      "id": "51c1b9be-a3e1-4a93-bb5c-bbde5919de0c",
      "name": "Analyseur de sortie structur√©e",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "position": [
        580,
        -80
      ],
      "parameters": {
        "jsonSchemaExample": "{\n  \"output\": {\n    \"topic\": \"the best ai models 2025\",\n    \"searchQueries\": [\n      \"best AI models 2025 natural language processing\",\n      \"top AI models 2025 computer vision\",\n      \"best AI models 2025 generative AI\",\n      \"recent advancements in AI models 2025 news\",\n      \"scholarly research on AI models 2020-2025\",\n      \"ethical concerns in AI models 2025\",\n      \"AI models 2025 applications in healthcare\",\n      \"AI models 2025 trends in automation\"\n    ]\n  }\n}"
      },
      "typeVersion": 1.2
    },
    {
      "id": "2d30f75e-baa0-4dd3-a0f9-cb74d7272d08",
      "name": "Diviser la sortie",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        1500,
        -320
      ],
      "parameters": {
        "options": {},
        "fieldToSplitOut": " introduction, summary, key_findings, news_highlights, scholarly_insights, wikipedia_summary, sources"
      },
      "typeVersion": 1
    },
    {
      "id": "b89d5c35-64c4-4e8c-b432-c2219aba8acc",
      "name": "Validation d'entr√©e",
      "type": "n8n-nodes-base.code",
      "position": [
        180,
        -320
      ],
      "parameters": {
        "jsCode": "// Validate input and prepare for processing\nconst query = $input.all()[0].json.query;\n\nif (!query || query.trim().length < 3) {\n  throw new Error('Research query must be at least 3 characters long');\n}\n\nreturn {\n  json: {\n    originalQuery: query,\n    cleanedQuery: query.trim().toLowerCase(),\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "typeVersion": 2
    },
    {
      "id": "e34f9b0e-a9ca-4011-bfee-c7845c68942b",
      "name": "Analyser la sortie de recherche",
      "type": "n8n-nodes-base.code",
      "position": [
        1300,
        -320
      ],
      "parameters": {
        "jsCode": "// Get the output string from the Research AI Agent\nconst outputString = $input.first().json.output;\n\n// Parse the string into a JSON object\nconst parsedOutput = JSON.parse(outputString);\n\n// Return the parsed JSON as a single item\nreturn [{\n  json: parsedOutput\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "f4e6e449-1c56-4500-9701-623620360c83",
      "name": "Fusionner les √©l√©ments divis√©s",
      "type": "n8n-nodes-base.code",
      "position": [
        1700,
        -320
      ],
      "parameters": {
        "jsCode": "const mergedItem = {\n  key_findings: [],\n  news_highlights: [],\n  scholarly_insights: [],\n  sources: []\n};\n\n$input.all().forEach(item => {\n  const data = item.json;\n\n  if (data.introduction) mergedItem.introduction = data.introduction;\n  if (data.summary) mergedItem.summary = data.summary;\n  if (data.wikipedia_summary) mergedItem.wikipedia_summary = data.wikipedia_summary;\n\n  if (data.key_findings) {\n    const findingsToAdd = Array.isArray(data.key_findings) ? data.key_findings : [data.key_findings];\n    mergedItem.key_findings = mergedItem.key_findings.concat(findingsToAdd);\n  }\n  if (data.news_highlights) {\n    const highlightsToAdd = Array.isArray(data.news_highlights) ? data.news_highlights : [data.news_highlights];\n    mergedItem.news_highlights = mergedItem.news_highlights.concat(highlightsToAdd);\n  }\n  if (data.scholarly_insights) {\n    const insightsToAdd = Array.isArray(data.scholarly_insights) ? data.scholarly_insights : [data.scholarly_insights];\n    mergedItem.scholarly_insights = mergedItem.scholarly_insights.concat(insightsToAdd);\n  }\n  if (data.sources) {\n    const sourcesToAdd = Array.isArray(data.sources) ? data.sources : [data.sources];\n    mergedItem.sources = mergedItem.sources.concat(sourcesToAdd);\n  }\n});\n\nreturn [{ json: mergedItem }];"
      },
      "typeVersion": 2
    },
    {
      "id": "e63a3f5d-dba7-4fc4-afa0-150e63aedbac",
      "name": "Stocker les m√©tadonn√©es de recherche",
      "type": "n8n-nodes-base.googleSheets",
      "position": [
        2100,
        -720
      ],
      "parameters": {
        "columns": {
          "value": {
            "Topic": "={{ $json.topic }}",
            "Sources": "={{ $json.sources }}",
            "Timestamp": "={{ $json.timestamp }}",
            "Search Queries": "={{ $json.searchQueries }}"
          },
          "schema": [
            {
              "id": "Topic",
              "type": "string",
              "display": true,
              "required": false,
              "displayName": "Topic",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "Search Queries",
              "type": "string",
              "display": true,
              "required": false,
              "displayName": "Search Queries",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "Sources",
              "type": "string",
              "display": true,
              "required": false,
              "displayName": "Sources",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            },
            {
              "id": "Timestamp",
              "type": "string",
              "display": true,
              "required": false,
              "displayName": "Timestamp",
              "defaultMatch": false,
              "canBeUsedToMatch": true
            }
          ],
          "mappingMode": "defineBelow",
          "matchingColumns": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {},
        "operation": "append",
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "gid=0",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196eJesF2ke3AQjoWvave51m6FltAyBFj5pvVW7wIsUA/edit#gid=0",
          "cachedResultName": "Sheet1"
        },
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": "196eJesF2ke3AQjoWvave51m6FltAyBFj5pvVW7wIsUA",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196eJesF2ke3AQjoWvave51m6FltAyBFj5pvVW7wIsUA/edit?usp=drivesdk",
          "cachedResultName": "Research AI Agent Records"
        }
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "PRTItuUGXlUOvF9a",
          "name": "Google Sheets account"
        }
      },
      "typeVersion": 4.5
    },
    {
      "id": "2501bc98-a1b4-473b-b4ac-7fd78efcb6be",
      "name": "Note adh√©sive",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1080,
        -1200
      ],
      "parameters": {
        "color": 6,
        "width": 2900,
        "height": 1600,
        "content": "# üìã Flux de travail du rapport de recherche üß†üíª\n\nCe flux de travail g√©n√®re un rapport de recherche professionnel au format PDF sur un sujet donn√©, l'envoie via Telegram, et par emailüöÄ\n\n\n---\n\n## üîç **Affinage de la requ√™te**\n- **Ce que √ßa fait** : Affine le sujet d'entr√©e pour une meilleure lisibilit√©. üßπ\n- **Entr√©e** : Sujet provenant de la requ√™te HTTP (ex. : \"the best ai models 2025\").\n- **Sortie** : Sujet format√© (ex. : \"The Best AI Models 2025\").\n- **‚ú® D√©tail** : Met en majuscule les mots et s'assure que \"AI\" est en majuscules.\n\n---\n\n## üìä **Agr√©gation des donn√©es de recherche**\n- **Ce que cela fait** : Collecte des donn√©es de recherche pour le sujet. üìö\n- **Entr√©e** : Sujet affin√©.\n- **Sortie** : Donn√©es de recherche (introduction, r√©sum√©, r√©sultats cl√©s, etc.) avec un horodatage.\n- **‚è∞ Note** : L'horodatage est utilis√© pour dater le rapport.\n\n---\n\n## üîó **Fusionner les √©l√©ments divis√©s**\n- **Ce que √ßa fait** : Combine et organise les donn√©es de recherche en sections. üóÇÔ∏è\n- **Entr√©e** : Donn√©es provenant de Aggregate Research Data.\n- **Sortie** : JSON structur√© avec des sections comme `introduction`, `key_findings`, `sources`.\n- **üìë Objectif** : Pr√©pare les donn√©es pour le rapport PDF.\n\n---\n\n## üìù **G√©n√©rer le HTML du PDF**\n- **Ce que cela fait** : Cr√©e un mod√®le HTML pour le rapport PDF. üñ•Ô∏è\n- **Entr√©e** : Sujet affin√© et donn√©es de recherche.\n- **Sortie** : Contenu HTML, nom de fichier (ex. `research-report-the-best-ai-models-2025-2025-04-09.pdf`), et date format√©e.\n- **üé® Caract√©ristiques** :\n  - Style professionnel (polices Helvetica, Georgia, accents bleu profond).\n  - Sections : page de couverture, introduction, r√©sum√©, conclusions cl√©s, etc.\n  - √âchappe les caract√®res sp√©ciaux pour √©viter les erreurs HTML.\n- **‚è≥ Correction de l‚Äôhorodatage** : Stocke `rawTimestamp` et `formattedDate` (ex. ¬´ April 9, 2025 ¬ª).\n\n---\n\n## üìÑ **Convertir HTML en PDF (PDFShift)**\n- **Ce que cela fait** : Convertit le HTML en PDF en utilisant l'API PDFShift. üñ®Ô∏è\n- **Entr√©e** : Contenu HTML du n≈ìud pr√©c√©dent.\n- **Sortie** : R√©ponse JSON avec une URL vers le PDF g√©n√©r√©.\n- **üîë Exigence** : N√©cessite une cl√© API PDFShift valide.\n- **‚ö†Ô∏è Remarque** : Produit une URL, pas les donn√©es binaires du PDF.\n\n---\n\n## ‚¨áÔ∏è **T√©l√©charger le PDF**\n- **Ce que cela fait** : T√©l√©charge le PDF depuis l‚ÄôURL fournie par PDFShift. üì•\n- **Entr√©e** : URL du PDF provenant du n≈ìud Convertir HTML en PDF.\n- **Sortie** : Donn√©es PDF binaires (type MIME : `application/pdf`, ~98 Ko).\n- **üìõ Nom du fichier** : Utilise le nom de fichier du n≈ìud pr√©c√©dent (ex. : `research-report-the-best-ai-models-2025-2025-04-09.pdf`).\n\n---\n\n## üì± **Gmail/Telegram**\n- **Ce que cela fait** : Envoie le PDF √† un chat Gmail/Telegram. üí¨\n- **Entr√©e** : Donn√©es binaires PDF et m√©tadonn√©es (sujet, date format√©e).\n- **Sortie** : Envoie le PDF en tant que document au chat sp√©cifi√©.\n- **üìù L√©gende** :"
      },
      "typeVersion": 1
    },
    {
      "id": "b2219fba-c5e5-4c0e-abf2-04a8ef60b795",
      "name": "G√©n√©rer le HTML du PDF",
      "type": "n8n-nodes-base.code",
      "position": [
        2120,
        -320
      ],
      "parameters": {
        "jsCode": "// Function to escape HTML special characters\nfunction escapeHtml(unsafe) {\n  if (typeof unsafe !== 'string') return unsafe;\n  return unsafe\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/'/g, \"&#039;\");\n}\n\n// Get topic from Query Refiner\nconst queryRefinerData = $('Query Refiner').first().json;\nconsole.log('Debugging queryRefinerData:', JSON.stringify(queryRefinerData, null, 2));\nconst topicRaw = queryRefinerData.output?.topic || 'Untitled';\nconst topic = topicRaw.split(' ').map(word => {\n  if (word.toLowerCase() === 'ai') return 'AI';\n  return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();\n}).join(' ');\n\n// Get timestamp from Aggregate Research Data\nconst aggregateData = $input.first().json;\nconsole.log('Debugging aggregateData:', JSON.stringify(aggregateData, null, 2));\n\n// Validate and parse the timestamp\nlet rawTimestamp = aggregateData.timestamp;\nif (!rawTimestamp || isNaN(new Date(rawTimestamp))) {\n  rawTimestamp = new Date().toISOString(); // Fallback to current date if invalid\n}\nconst formattedDate = new Date(rawTimestamp).toLocaleDateString('en-US', {\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\nconsole.log('Raw timestamp:', rawTimestamp);\nconsole.log('Formatted date:', formattedDate);\n\n// Get the aggregated research data from Merge Split Items\nconst mergeSplitItems = $('Merge Split Items').first().json;\nconsole.log('Data from Merge Split Items:', JSON.stringify(mergeSplitItems, null, 2));\n\n// Use data from Merge Split Items\nconst data = {\n  topic: topic,\n  rawTimestamp: rawTimestamp, // Store the raw timestamp\n  formattedDate: formattedDate, // Store the formatted date\n  introduction: mergeSplitItems.introduction,\n  summary: mergeSplitItems.summary,\n  key_findings: mergeSplitItems.key_findings,\n  news_highlights: mergeSplitItems.news_highlights,\n  scholarly_insights: mergeSplitItems.scholarly_insights,\n  wikipedia_summary: mergeSplitItems.wikipedia_summary,\n  sources: mergeSplitItems.sources\n};\n\n// Ensure array fields are arrays, default to empty array if not\nconst keyFindings = Array.isArray(data.key_findings) ? data.key_findings : [];\nconst newsHighlights = Array.isArray(data.news_highlights) ? data.news_highlights : [];\nconst scholarlyInsights = Array.isArray(data.scholarly_insights) ? data.scholarly_insights : [];\nconst sources = Array.isArray(data.sources) ? data.sources : [];\n\n// Define the file name based on the topic\nconst fileName = `research-report-${(data.topic || 'untitled').replace(/\\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.pdf`;\n\n// Create an HTML template for the PDF with enhanced styling\nconst htmlContent = `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Research Report: ${escapeHtml(data.topic)}</title>\n  <style>\n    @page {\n      size: A4;\n      margin: 0;\n      @top-center {\n        content: \"Research Report: ${escapeHtml(data.topic)}\";\n        font-family: 'Helvetica', sans-serif;\n        font-size: 10pt;\n        color: #666;\n      }\n      @bottom-right {\n        content: counter(page);\n        font-family: 'Helvetica', sans-serif;\n        font-size: 10pt;\n        color: #666;\n      }\n    }\n    body {\n      font-family: 'Helvetica', 'Arial', sans-serif;\n      margin: 0;\n      padding: 0;\n      color: #333;\n      line-height: 1.6;\n      font-size: 12pt;\n    }\n    .page-break {\n      page-break-before: always;\n    }\n    .container {\n      width: 90%;\n      max-width: 800px;\n      margin: 0 auto;\n      padding: 40px 30px;\n      background-color: #fff;\n    }\n    /* Cover Page */\n    .cover-page {\n      text-align: center;\n      padding: 100px 30px;\n      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n      height: 100vh;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      box-sizing: border-box;\n    }\n    .cover-page h1 {\n      font-family: 'Georgia', serif;\n      font-size: 40pt;\n      font-weight: bold;\n      color: #1a3c5e;\n      margin: 0;\n      text-transform: uppercase;\n      letter-spacing: 2px;\n    }\n    .cover-page p {\n      font-size: 14pt;\n      color: #555;\n      margin: 20px 0;\n      font-style: italic;\n    }\n    /* Header */\n    .header {\n      border-bottom: 2px solid #1a3c5e;\n      padding: 15px 0;\n      text-align: center;\n      margin-bottom: 30px;\n    }\n    .header h1 {\n      font-family: 'Georgia', serif;\n      font-size: 24pt;\n      font-weight: bold;\n      color: #1a3c5e;\n      margin: 0;\n      text-transform: uppercase;\n    }\n    .header p {\n      font-size: 10pt;\n      color: #666;\n      margin: 5px 0 0;\n      font-style: italic;\n    }\n    /* Sections */\n    .section {\n      margin: 40px 0;\n      padding-bottom: 20px;\n      border-bottom: 1px solid #e0e0e0;\n    }\n    .section:last-child {\n      border-bottom: none;\n    }\n    .section h2 {\n      font-family: 'Georgia', serif;\n      font-size: 18pt;\n      font-weight: bold;\n      color: #1a3c5e;\n      margin-bottom: 15px;\n      position: relative;\n    }\n    .section h2::after {\n      content: '';\n      position: absolute;\n      left: 0;\n      bottom: -5px;\n      width: 50px;\n      height: 2px;\n      background-color: #1a3c5e;\n    }\n    .section p {\n      font-size: 12pt;\n      margin: 0 0 15px;\n      color: #444;\n    }\n    .section ul {\n      margin: 0;\n      padding-left: 20px;\n    }\n    .section li {\n      font-size: 12pt;\n      margin: 10px 0;\n      color: #444;\n    }\n    /* Highlighted Key Findings */\n    .key-finding-highlight {\n      background-color: #f0f5fa;\n      padding: 15px;\n      border-left: 4px solid #1a3c5e;\n      margin: 10px 0;\n      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n      border-radius: 4px;\n    }\n    .key-finding-highlight span {\n      font-weight: bold;\n      color: #1a3c5e;\n    }\n    /* Sources */\n    .sources ol {\n      margin: 0;\n      padding-left: 20px;\n    }\n    .sources li {\n      font-size: 11pt;\n      margin: 8px 0;\n      word-break: break-all;\n    }\n    .sources a {\n      color: #1a73e8;\n      text-decoration: none;\n    }\n    .sources a:hover {\n      text-decoration: underline;\n    }\n    /* Footer */\n    .footer {\n      text-align: center;\n      font-size: 10pt;\n      color: #666;\n      padding: 20px 0;\n      border-top: 1px solid #e0e0e0;\n      margin-top: 40px;\n      font-style: italic;\n    }\n  </style>\n</head>\n<body>\n  <!-- Cover Page -->\n  <div class=\"cover-page\">\n    <h1>Research Report: ${escapeHtml(data.topic)}</h1>\n    <p>Generated on: ${escapeHtml(data.formattedDate)}</p>\n  </div>\n\n  <!-- Main Content -->\n  <div class=\"page-break\"></div>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Research Report: ${escapeHtml(data.topic)}</h1>\n      <p>Generated on: ${escapeHtml(data.formattedDate)}</p>\n    </div>\n\n    <div class=\"section\" id=\"introduction\">\n      <h2>Introduction</h2>\n      <p>${escapeHtml(data.introduction) || 'No introduction available.'}</p>\n    </div>\n\n    <div class=\"section\" id=\"summary\">\n      <h2>Summary</h2>\n      <p>${escapeHtml(data.summary) || 'No summary available.'}</p>\n    </div>\n\n    <div class=\"section\" id=\"key-findings\">\n      <h2>Key Findings</h2>\n      <ul>\n        ${keyFindings.length > 0 ? keyFindings.map((finding, index) => {\n          if (index < 3) {\n            return `<li class=\"key-finding-highlight\"><span>${escapeHtml(finding)}</span></li>`;\n          }\n          return `<li>${escapeHtml(finding)}</li>`;\n        }).join('') : '<li>No key findings available.</li>'}\n      </ul>\n    </div>\n\n    <div class=\"section\" id=\"news-highlights\">\n      <h2>News Highlights</h2>\n      <ul>\n        ${newsHighlights.length > 0 ? newsHighlights.map(highlight => `<li>${escapeHtml(highlight)}</li>`).join('') : '<li>No news highlights available.</li>'}\n      </ul>\n    </div>\n\n    <div class=\"section\" id=\"scholarly-insights\">\n      <h2>Scholarly Insights</h2>\n      <ul>\n        ${scholarlyInsights.length > 0 ? scholarlyInsights.map(insight => `<li>${escapeHtml(insight)}</li>`).join('') : '<li>No scholarly insights available.</li>'}\n      </ul>\n    </div>\n\n    <div class=\"section\" id=\"wikipedia-summary\">\n      <h2>Wikipedia Summary</h2>\n      <p>${escapeHtml(data.wikipedia_summary) || 'No Wikipedia summary available.'}</p>\n    </div>\n\n    <div class=\"section sources\" id=\"sources\">\n      <h2>Sources</h2>\n      <ol>\n        ${sources.length > 0 ? sources.map(source => `<li><a href=\"${escapeHtml(source)}\" target=\"_blank\">${escapeHtml(source)}</a></li>`).join('') : '<li>No sources available.</li>'}\n      </ol>\n    </div>\n\n    <div class=\"footer\">\n      <p>Generated by ResearchBot | ¬© 2025</p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\n// Return the HTML content and file name\nreturn [{\n  json: {\n    htmlContent: htmlContent,\n    fileName: fileName,\n    topic: data.topic,\n    rawTimestamp: data.rawTimestamp,\n    formattedDate: data.formattedDate\n  }\n}];"
      },
      "typeVersion": 2
    },
    {
      "id": "e43bd216-af6a-43a4-9432-c092e34b83ba",
      "name": "Convertir le HTML en PDF",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2300,
        -320
      ],
      "parameters": {
        "url": "https://api.pdfshift.io/v3/convert/pdf",
        "method": "POST",
        "options": {
          "response": {
            "response": {}
          }
        },
        "sendBody": true,
        "sendHeaders": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "=source",
              "value": "={{ $json.htmlContent }}"
            },
            {
              "name": "landscape",
              "value": "false"
            },
            {
              "name": "use_print",
              "value": "false"
            },
            {
              "name": "filename",
              "value": "={{ $json.fileName }}"
            }
          ]
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "Basic YXBpOnNrX2VhNDVmY2YxN2E1NjMxY2I1ZmQxZGVmNjJmZTY3Y2JiYjM3MjQ2N2M="
            }
          ]
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "fef45c7d-578b-4202-b804-db4de8a3ab5f",
      "name": "Agr√©ger",
      "type": "n8n-nodes-base.aggregate",
      "position": [
        1900,
        -320
      ],
      "parameters": {
        "options": {},
        "aggregate": "aggregateAllItemData"
      },
      "typeVersion": 1
    },
    {
      "id": "3d942072-ad3f-4d9a-a5f4-48df2d1644b4",
      "name": "T√©l√©charger le PDF",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2500,
        -320
      ],
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "5763bd13-f98a-4983-b61d-72efad31f488",
      "name": "Envoyer la recherche √† Gmail",
      "type": "n8n-nodes-base.gmail",
      "position": [
        2820,
        0
      ],
      "webhookId": "ef2f7336-e7d4-4476-a65e-951d92138f0b",
      "parameters": {
        "sendTo": "example@gmail.com",
        "message": "=<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Rapport de recherche : {{ $('Generate PDF HTML').item.json.topic }}</title>\n  <style>\n    body {\n      font-family: 'Arial', sans-serif;\n      color: #333;\n      line-height: 1.6;\n      background-color: #f4f4f4;\n      margin: 0;\n      padding: 0;\n    }\n    .container {\n      max-width: 600px;\n      margin: 20px auto;\n      background-color: #ffffff;\n      padding: 30px;\n      border-radius: 8px;\n      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n    }\n    .header {\n      text-align: center;\n      border-bottom: 2px solid #1a3c5e;\n      padding-bottom: 15px;\n      margin-bottom: 20px;\n    }\n    .header h1 {\n      font-size: 24px;\n      color: #1a3c5e;\n      margin: 0;\n    }\n    .content p {\n      font-size: 16px;\n      margin: 0 0 15px;\n    }\n    .content p strong {\n      color: #1a3c5e;\n    }\n    .content a {\n      color: #1a73e8;\n      text-decoration: none;\n    }\n    .content a:hover {\n      text-decoration: underline;\n    }\n    .signature {\n      margin-top: 20px;\n      font-size: 14px;\n      color: #666;\n      border-top: 1px solid #e0e0e0;\n      padding-top: 15px;\n    }\n    .signature p {\n      margin: 5px 0;\n    }\n    .footer {\n      text-align: center;\n      font-size: 12px;\n      color: #999;\n      margin-top: 20px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Rapport de recherche : {{ $('Generate PDF HTML').item.json.topic }}</h1>\n    </div>\n    <div class=\"content\">\n      <p>Cher Immanuel,</p>\n      <p>J‚Äôesp√®re que ce courriel vous trouve en bonne sant√©.\n\nJ'ai le plaisir de vous pr√©senter un rapport de recherche complet sur \"<strong>{{ $('Generate PDF HTML').item.json.topic }}</strong>\", g√©n√©r√© le <strong>{{ $('Generate PDF HTML').item.json.formattedDate }}</strong>.</p>\n      <p>Ce rapport offre une analyse approfondie, incluant une introduction d√©taill√©e, un r√©sum√©, les principaux r√©sultats, les faits marquants de l'actualit√©, des perspectives acad√©miques, ainsi qu'un r√©sum√© Wikipedia, tous appuy√©s par des sources fiables.\n\nIl est con√ßu pour offrir des informations pr√©cieuses et des donn√©es exploitables afin de soutenir vos recherches, votre prise de d√©cision ou vos besoins de projet.</p>\n      <p>Veuillez trouver le rapport joint au format PDF pour votre examen.\n\nSi vous avez des questions, souhaitez obtenir plus de d√©tails ou discuter des r√©sultats, n‚Äôh√©sitez pas √† me contacter‚Äîje serais ravi de vous aider.</p>\n      <p>Merci pour votre int√©r√™t, et j‚Äôattends avec impatience votre retour.</p>\n    </div>\n    <div class=\"signature\">\n      <p>Cordialement,</p>\n      <p>Immanuel</p>\n    \n    </div>\n    <div class=\"footer\">\n      <p>G√©n√©r√© par Em | ¬© 2025</p>\n    </div>\n  </div>\n</body>\n</html>.",
        "options": {
          "attachmentsUi": {
            "attachmentsBinary": [
              {}
            ]
          },
          "appendAttribution": false
        },
        "subject": "=Rapport de recherche : {{ $('Query Refiner').first().json.output.topic.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ') }}"
      },
      "credentials": {
        "gmailOAuth2": {
          "id": "EGZrlZO8SHs37XwL",
          "name": "Gmail Email "
        }
      },
      "typeVersion": 2.1
    },
    {
      "id": "438acbf5-5609-4c89-8448-c248e5d9bcaf",
      "name": "Lors du clic sur ‚ÄòTester le workflow‚Äô",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -40,
        -220
      ],
      "parameters": {},
      "typeVersion": 1
    },
    {
      "id": "9545380e-e0aa-405c-9230-eb89354b6775",
      "name": "Envoyer le PDF",
      "type": "n8n-nodes-base.telegram",
      "position": [
        2800,
        -340
      ],
      "webhookId": "1b2f4bf7-8838-48db-ae75-e50c2a18b815",
      "parameters": {
        "chatId": "1274041539",
        "operation": "sendDocument",
        "binaryData": true,
        "additionalFields": {}
      },
      "credentials": {
        "telegramApi": {
          "id": "0BctZPpJYxRsKfET",
          "name": "Telegram Airbnb A"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "0c0e336e-12f7-4fa2-b375-c3fcc6630f7e",
      "name": "Ex√©cut√© par l'Agent IA Principal",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -40,
        -420
      ],
      "parameters": {
        "inputSource": "passthrough"
      },
      "typeVersion": 1.1
    },
    {
      "id": "c12851da-98dd-4785-8dc2-844bedfd5f1e",
      "name": "Dossier de Recherche",
      "type": "n8n-nodes-base.googleDrive",
      "position": [
        2500,
        -720
      ],
      "parameters": {
        "filter": {},
        "options": {},
        "resource": "fileFolder",
        "queryString": "=name='Research Reports'"
      },
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "9wskupj06ArN8KFy",
          "name": "Google Drive account"
        }
      },
      "typeVersion": 3
    },
    {
      "id": "c8f7d2db-f5b2-4e6d-8c43-2d37e5a9306a",
      "name": "Si",
      "type": "n8n-nodes-base.if",
      "position": [
        2700,
        -720
      ],
      "parameters": {
        "options": {},
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "14231a0f-aae8-4e31-af03-b7a1da1cbc3d",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $node[\"Google Drive\"].json.length > 0 }}",
              "rightValue": ""
            }
          ]
        }
      },
      "typeVersion": 2.2
    }
  ],
  "active": false,
  "pinData": {
    "When clicking ‚ÄòTest workflow‚Äô": [
      {
        "json": {
          "query": "Facts about Thailand"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e51160d8-0107-48ec-ad91-54843134df2c",
  "connections": {
    "SerpApi": {
      "ai_tool": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agr√©ger": {
      "main": [
        [
          {
            "node": "Stocker les m√©tadonn√©es de recherche",
            "type": "main",
            "index": 0
          },
          {
            "node": "G√©n√©rer le HTML du PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Diviser la sortie": {
      "main": [
        [
          {
            "node": "Fusionner les √©l√©ments divis√©s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wikipedia": {
      "ai_tool": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Rechercher des actualit√©s": {
      "ai_tool": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "T√©l√©charger le PDF": {
      "main": [
        [
          {
            "node": "Envoyer la recherche √† Gmail",
            "type": "main",
            "index": 0
          },
          {
            "node": "Envoyer le PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Affinage de requ√™te": {
      "main": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dossier de Recherche": {
      "main": [
        [
          {
            "node": "Si",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "M√©moire simple": {
      "ai_memory": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Validation d'entr√©e": {
      "main": [
        [
          {
            "node": "Affinage de requ√™te",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "G√©n√©rer le HTML du PDF": {
      "main": [
        [
          {
            "node": "Convertir le HTML en PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recherche Google Web": {
      "ai_tool": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Fusionner les √©l√©ments divis√©s": {
      "main": [
        [
          {
            "node": "Agr√©ger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mod√®le de chat OpenAI": {
      "ai_languageModel": [
        [
          {
            "node": "Agent IA de recherche",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Agent IA de recherche": {
      "main": [
        [
          {
            "node": "Analyser la sortie de recherche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mod√®le de chat OpenAI1": {
      "ai_languageModel": [
        [
          {
            "node": "Affinage de requ√™te",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Convertir le HTML en PDF": {
      "main": [
        [
          {
            "node": "T√©l√©charger le PDF",
            "type": "main",
            "index": 0
          },
          {
            "node": "Dossier de Recherche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyser la sortie de recherche": {
      "main": [
        [
          {
            "node": "Diviser la sortie",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envoyer la recherche √† Gmail": {
      "main": [
        []
      ]
    },
    "Analyseur de sortie structur√©e": {
      "ai_outputParser": [
        [
          {
            "node": "Affinage de requ√™te",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Ex√©cut√© par l'Agent IA Principal": {
      "main": [
        []
      ]
    },
    "Lors du clic sur ‚ÄòTester le workflow‚Äô": {
      "main": [
        [
          {
            "node": "Validation d'entr√©e",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
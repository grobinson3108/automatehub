<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Generation & Editing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    .drop-active { border-color: rgb(59 130 246); background-color: rgba(59,130,246,.05); }
    .visually-hidden { position:absolute; clip:rect(0 0 0 0); width:1px; height:1px; margin:-1px; overflow:hidden; }
    a.link { text-decoration: underline; text-underline-offset: 2px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <main class="max-w-4xl mx-auto px-4 py-10">
    <!-- Header -->
    <header class="mb-8 text-center">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-semibold tracking-wide uppercase">Automation Tribe</div>
      <h1 class="mt-3 text-3xl font-semibold tracking-tight">Generate & Edit Images</h1>
      <p class="text-gray-600 mt-2">Upload an image, provide a prompt, and choose an action.</p>
    </header>

    <!-- Alert -->
    <div id="alert" class="hidden mb-6 rounded-lg border border-red-200 bg-red-50 text-red-800 px-4 py-3 text-sm" role="alert" aria-live="polite"></div>

    <!-- Step 1: Inputs -->
    <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center justify-center size-7 rounded-full bg-blue-100 text-blue-700 text-sm font-medium">1</span>
        <h2 class="text-xl font-semibold">Upload Image & Add Prompt</h2>
      </div>

      <!-- Uploader -->
      <div>
        <p class="text-sm font-medium text-gray-700 mb-2">Upload an image (optional for 'Generate')</p>
        <div id="dropzone" class="rounded-2xl border-2 border-dashed border-gray-300 p-6 text-center cursor-pointer select-none bg-gray-50 hover:bg-gray-100 transition">
          <input id="fileInput" type="file" accept=".png,.jpg,.jpeg,.webp" class="visually-hidden" />
          <div class="flex flex-col items-center">
            <svg class="size-8 text-gray-400 mb-2" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 16a4 4 0 118 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12 12V4m0 0l-3 3m3-3l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><rect x="3" y="14" width="18" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/></svg>
            <p class="text-sm text-gray-700"><span class="font-medium">Click to upload</span> or drag & drop</p>
          </div>
        </div>

        <!-- Canvas preview -->
        <div id="previewArea" class="hidden mt-3">
          <div class="mt-3 border rounded-xl overflow-hidden">
            <canvas id="uploadCanvas" class="w-full h-auto block"></canvas>
          </div>
        </div>
      </div>

      <!-- Prompt Area -->
      <div class="mt-6">
        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
        <textarea id="prompt" rows="4" class="w-full resize-y rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 p-4 text-[15px]" placeholder="e.g., a cinematic shot of a cat wearing sunglasses..."></textarea>
      </div>
    </section>

    <!-- Step 2: Generate & Result -->
    <section id="resultCard" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center justify-center size-7 rounded-full bg-emerald-100 text-emerald-700 text-sm font-medium">2</span>
        <h2 class="text-xl font-semibold">Choose Action & View Result</h2>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-4">
        <button id="btnGenerate" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 text-white px-5 py-3 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-emerald-700 transition-all" disabled>
          <svg id="spinGenerate" class="hidden animate-spin size-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"></path></svg>
          <span>Generate Image</span>
        </button>
        <button id="btnEdit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 text-white px-5 py-3 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-all" disabled>
          <svg id="spinEdit" class="hidden animate-spin size-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"></path></svg>
          <span>Edit Image</span>
        </button>
      </div>

      <div id="resultArea" class="mt-6 relative min-h-56 border border-dashed border-gray-200 rounded-xl p-4 bg-gray-50">
        <div id="placeholder" class="text-gray-500 text-sm text-center">Your generated image will appear here.</div>
        <canvas id="resultCanvas" class="hidden w-full h-auto"></canvas>
        <div id="overlay" class="hidden absolute inset-0 bg-white/70 backdrop-blur-sm rounded-xl grid place-items-center">
          <div id="loadingText" class="flex items-center gap-3 text-gray-700 text-sm">
            <svg class="animate-spin size-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"></path></svg>
            <span>Generating…</span>
          </div>
        </div>
      </div>

      <!-- Download Button -->
      <div class="mt-4">
        <button id="btnDownload" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 px-4 py-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg class="size-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 4v12m0 0l-4-4m4 4l4-4M4 20h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Download Image</span>
        </button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500">
      Made by <a href="https://www.automation-tribe.com/" target="_blank" rel="noopener" class="link">Automation Tribe</a>.
    </footer>
  </main>

  <script>
    // ========= WEBHOOK URL =========
    const WEBHOOK_URL = "https://sumobundle-u31317.vm.elestio.app/webhook-test/cbf59f44-4222-41a8-8894-b974849bde4c";

    // ========= DOM Refs =========
    const alertBox = document.getElementById("alert");
    const promptInput = document.getElementById("prompt");

    // Uploader
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const previewArea = document.getElementById("previewArea");
    const uploadCanvas = document.getElementById("uploadCanvas");

    // Actions
    const btnGenerate = document.getElementById("btnGenerate");
    const btnEdit = document.getElementById("btnEdit");
    const spinGenerate = document.getElementById("spinGenerate");
    const spinEdit = document.getElementById("spinEdit");

    // Result
    const overlay = document.getElementById("overlay");
    const loadingText = document.getElementById("loadingText");
    const placeholder = document.getElementById("placeholder");
    const resultCanvas = document.getElementById("resultCanvas");
    const btnDownload = document.getElementById("btnDownload");

    // ========= State =========
    let imageFile = null;
    let lastImageBlob = null; // To store the blob for downloading

    // ========= Utils =========
    function showAlert(msg) {
      if (!msg) { alertBox.classList.add("hidden"); return; }
      alertBox.textContent = msg;
      alertBox.classList.remove("hidden");
      setTimeout(() => alertBox.classList.add("hidden"), 5000);
    }
    
    function updateButtonStates() {
      const hasPrompt = promptInput.value.trim().length > 0;
      const hasImage = !!imageFile;

      // Generate button only needs a prompt
      btnGenerate.disabled = !hasPrompt;

      // Edit button needs both a prompt and an image
      btnEdit.disabled = !(hasPrompt && hasImage);
    }

    promptInput.addEventListener("input", updateButtonStates);

    async function imageBitmapFromFile(file) {
      const blob = new Blob([await file.arrayBuffer()], { type: file.type });
      return await createImageBitmap(blob);
    }

    // ========= File Handling =========
    async function handleFile(file) {
      const ACCEPT = ["image/png", "image/jpeg", "image/jpg", "image/webp"];
      if (!ACCEPT.includes(file.type)) { showAlert("Unsupported file type."); return; }
      if ((file.size / (1024 * 1024)) > 10) { showAlert(`File too large. Max is 10 MB.`); return; }

      imageFile = file;
      const bmp = await imageBitmapFromFile(file);
      uploadCanvas.width = bmp.width;
      uploadCanvas.height = bmp.height;
      uploadCanvas.getContext("2d").drawImage(bmp, 0, 0);
      previewArea.classList.remove("hidden");
      updateButtonStates();
    }

    dropzone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => handleFile(fileInput.files[0]));
    dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("drop-active"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("drop-active"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("drop-active");
      handleFile(e.dataTransfer.files[0]);
    });
    
    // Initialize buttons
    updateButtonStates();

    // ========= Generation/Editing Logic =========
    async function handleAction(actionType) {
      const isGenerating = actionType === 'generate';
      
      // Validation
      if (!promptInput.value.trim()) {
        showAlert("Please provide a prompt.");
        return;
      }
      if (!isGenerating && !imageFile) {
        showAlert("Please upload an image to use the 'Edit' function.");
        return;
      }
      
      const spinner = isGenerating ? spinGenerate : spinEdit;
      
      loadingText.querySelector('span').textContent = isGenerating ? 'Generating image…' : 'Editing image…';
      overlay.classList.remove("hidden");
      spinner.classList.remove("hidden");
      btnGenerate.disabled = true;
      btnEdit.disabled = true;
      btnDownload.disabled = true; // Disable download button during generation
      
      try {
        const form = new FormData();
        form.append("prompt", promptInput.value.trim());
        form.append("action", actionType); 

        // Only append the image if it exists
        if (imageFile) {
            form.append("image", imageFile);
        }

        const res = await fetch(WEBHOOK_URL, { method: "POST", body: form });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText.slice(0, 200)}`);
        }

        const responseBlob = await res.blob();
        lastImageBlob = responseBlob; // Store the blob for downloading
        const objUrl = URL.createObjectURL(responseBlob);
        
        const img = new Image();
        img.onload = () => {
          resultCanvas.width = img.width;
          resultCanvas.height = img.height;
          resultCanvas.getContext('2d').drawImage(img, 0, 0);
          placeholder.classList.add("hidden");
          resultCanvas.classList.remove("hidden");
          btnDownload.disabled = false; // Enable download button on success
          URL.revokeObjectURL(objUrl);
        };
        img.src = objUrl;

      } catch (err) {
        showAlert(`Error during '${actionType}': ${err.message}`);
      } finally {
        overlay.classList.add("hidden");
        spinner.classList.add("hidden");
        updateButtonStates(); // Re-enable action buttons based on current state
      }
    }
    
    btnGenerate.addEventListener("click", () => handleAction('generate'));
    btnEdit.addEventListener("click", () => handleAction('edit'));

    // ========= Download Logic =========
    function triggerDownload(href, filename){
      const a = document.createElement("a");
      a.href = href;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    btnDownload.addEventListener("click", async () => {
        if (!lastImageBlob) {
            showAlert("No image available to download.");
            return;
        }
        try {
            const url = URL.createObjectURL(lastImageBlob);
            triggerDownload(url, "generated-image.png");
            URL.revokeObjectURL(url);
        } catch (err) {
            showAlert("Could not download image: " + err.message);
        }
    });

  </script>
</body>
</html>

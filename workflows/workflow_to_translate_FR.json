{
  "meta": {
    "instanceId": "03e9d14e9196363fe7191ce21dc0bb17387a6e755dcc9acc4f5904752919dca8"
  },
  "nodes": [
    {
      "id": "1bad6bfc-9ec9-48a5-b8f7-73c4de3d08cf",
      "name": "Déclencheur Gmail",
      "type": "n8n-nodes-base.gmailTrigger",
      "position": [
        1480,
        160
      ],
      "parameters": {
        "simple": false,
        "filters": {},
        "options": {},
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        }
      },
      "credentials": {
        "gmailOAuth2": {
          "id": "kkhNhqKpZt6IUZd0",
          "name": " Gmail"
        }
      },
      "typeVersion": 1.2
    },
    {
      "id": "9ac747a1-4fd8-46ba-b4c1-75fd17aab2ed",
      "name": "Déclencheur Microsoft Outlook",
      "type": "n8n-nodes-base.microsoftOutlookTrigger",
      "disabled": true,
      "position": [
        1480,
        720
      ],
      "parameters": {
        "fields": [
          "body",
          "toRecipients",
          "subject",
          "bodyPreview"
        ],
        "output": "fields",
        "filters": {},
        "options": {},
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        }
      },
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "vTCK0oVQ0WjFrI5H",
          "name": " Outlook Credential"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "5bf9b0e8-b84e-44a2-aad2-45dde3e4ab1b",
      "name": "Capture d'écran HTML",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2520,
        480
      ],
      "parameters": {
        "url": "https://hcti.io/v1/image",
        "method": "POST",
        "options": {},
        "sendBody": true,
        "sendQuery": true,
        "authentication": "genericCredentialType",
        "bodyParameters": {
          "parameters": [
            {
              "name": "html",
              "value": "={{ $json.htmlBody }}"
            }
          ]
        },
        "genericAuthType": "httpBasicAuth",
        "queryParameters": {
          "parameters": [
            {}
          ]
        }
      },
      "credentials": {
        "httpBasicAuth": {
          "id": "8tm8mUWmPvtmPFPk",
          "name": "hcti.io"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "fc770d1d-6c18-4d14-8344-1dc042464df6",
      "name": "Récupérer la capture d'écran",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2700,
        480
      ],
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {},
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth"
      },
      "credentials": {
        "httpBasicAuth": {
          "id": "8tm8mUWmPvtmPFPk",
          "name": "hcti.io"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "2f3e5cc0-24e8-450a-898b-71e2d6f7bb58",
      "name": "Définir les variables Outlook",
      "type": "n8n-nodes-base.set",
      "position": [
        2020,
        720
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "38bd3db2-1a8d-4c40-a2dd-336e0cc84224",
              "name": "corpsHtml",
              "type": "string",
              "value": "={{ $('Microsoft Outlook Trigger').item.json.body.content }}"
            },
            {
              "id": "13bdd95b-ef02-486e-b38b-d14bd05a4a8a",
              "name": "enTetes",
              "type": "string",
              "value": "={{ $json}}"
            },
            {
              "id": "20566ad4-7eb7-42b1-8a0d-f8b759610f10",
              "name": "sujet",
              "type": "string",
              "value": "={{ $('Microsoft Outlook Trigger').item.json.subject }}"
            },
            {
              "id": "7171998f-a5a2-4e23-946a-9c1ad75710e7",
              "name": "destinataire",
              "type": "string",
              "value": "={{ $('Microsoft Outlook Trigger').item.json.toRecipients[0].emailAddress.address }}"
            },
            {
              "id": "cc262634-2470-4524-8319-abe2518a6335",
              "name": "corpsTexte",
              "type": "string",
              "value": "={{ $('Retrieve Headers of Email').item.json.body.content }}"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "374e5b16-a666-4706-9fd2-762b2927012d",
      "name": "Définir les variables Gmail",
      "type": "n8n-nodes-base.set",
      "position": [
        2040,
        160
      ],
      "parameters": {
        "options": {},
        "assignments": {
          "assignments": [
            {
              "id": "38bd3db2-1a8d-4c40-a2dd-336e0cc84224",
              "name": "corpsHtml",
              "type": "string",
              "value": "={{ $json.html }}"
            },
            {
              "id": "18fbcf78-6d3c-4036-b3a2-fb5adf22176a",
              "name": "enTetes",
              "type": "string",
              "value": "={{ $json.headers }}"
            },
            {
              "id": "1d690098-be2a-4604-baf8-62f314930929",
              "name": "sujet",
              "type": "string",
              "value": "={{ $json.subject }}"
            },
            {
              "id": "8009f00a-547f-4eb1-b52d-2e7305248885",
              "name": "destinataire",
              "type": "string",
              "value": "={{ $json.to.text }}"
            },
            {
              "id": "1932e97d-b03b-4964-b8bc-8262aaaa1f7a",
              "name": "corpsTexte",
              "type": "string",
              "value": "={{ $json.text }}"
            }
          ]
        }
      },
      "typeVersion": 3.4
    },
    {
      "id": "3166738e-d0a3-475b-8b19-51afd519ee3a",
      "name": "Récupérer les en-têtes de l'email",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1680,
        720
      ],
      "parameters": {
        "url": "=https://graph.microsoft.com/v1.0/me/messages/{{ $json.id }}?$select=internetMessageHeaders,body",
        "options": {},
        "sendHeaders": true,
        "authentication": "predefinedCredentialType",
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "outlook.body-content-type=\"text\""
            }
          ]
        },
        "nodeCredentialType": "microsoftOutlookOAuth2Api"
      },
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "vTCK0oVQ0WjFrI5H",
          "name": " Outlook Credential"
        }
      },
      "typeVersion": 4.2
    },
    {
      "id": "25ae222c-088f-4565-98d6-803c8c1b0826",
      "name": "Formater les en-têtes",
      "type": "n8n-nodes-base.code",
      "position": [
        1860,
        720
      ],
      "parameters": {
        "jsCode": "const input = $('Retrieve Headers of Email').item.json.internetMessageHeaders;\n\nconst result = input.reduce((acc, { name, value }) => {\n if (!acc[name]) acc[name] = [];\n acc[name].push(value);\n return acc;\n}, {});\n\nreturn result;"
      },
      "typeVersion": 2
    },
    {
      "id": "8f14f267-1074-43ea-968d-26a6ab36fd7b",
      "name": "Définir les variables Email",
      "type": "n8n-nodes-base.set",
      "position": [
        2360,
        480
      ],
      "parameters": {
        "options": {},
        "includeOtherFields": true
      },
      "typeVersion": 3.4
    },
    {
      "id": "45d156aa-91f4-483c-91d4-c9de4a4f595d",
      "name": "Analyse ChatGPT",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [
        3100,
        480
      ],
      "parameters": {
        "text": "=Décris cette image. Détermine si l'email pourrait être un email de phishing. Les en-têtes du message sont les suivants:\n{{ $('Set Email Variables').item.json.headers }}\n\nFormate la réponse pour Jira qui utilise un rendu de style wiki. N'inclus pas ``` autour de ta réponse.",
        "modelId": {
          "__rl": true,
          "mode": "list",
          "value": "chatgpt-4o-latest",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "options": {
          "maxTokens": 1500
        },
        "resource": "image",
        "inputType": "base64",
        "operation": "analyze"
      },
      "credentials": {
        "openAiApi": {
          "id": "76",
          "name": "OpenAi account"
        }
      },
      "typeVersion": 1.6
    },
    {
      "id": "62ca591b-6627-496c-96a7-95cb0081480d",
      "name": "Créer un ticket Jira",
      "type": "n8n-nodes-base.jira",
      "position": [
        3500,
        480
      ],
      "parameters": {
        "project": {
          "__rl": true,
          "mode": "list",
          "value": "10001",
          "cachedResultName": "Support"
        },
        "summary": "=Email de phishing signalé: \"{{ $('Set Email Variables').item.json.subject }}\"",
        "issueType": {
          "__rl": true,
          "mode": "list",
          "value": "10008",
          "cachedResultName": "Task"
        },
        "additionalFields": {
          "description": "=Un email de phishing a été signalé par {{ $('Set Email Variables').item.json.recipient }} avec la ligne d'objet \"{{ $('Set Email Variables').item.json.subject }}\" et le corps:\n{{ $('Set Email Variables').item.json.textBody }}\n\\\\\n\\\\\n\\\\\nh2. Voici l'analyse de l'email par ChatGPT:\n{{ $json.content }}"
        }
      },
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "BZmmGUrNIsgM9fDj",
          "name": "New Jira Cloud"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "071380c8-8070-4f8f-86c6-87c4ee3bc261",
      "name": "Renommer la capture d'écran",
      "type": "n8n-nodes-base.code",
      "position": [
        3680,
        480
      ],
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "$('Retrieve Screenshot').item.binary.data.fileName = 'emailScreenshot.png'\n\nreturn $('Retrieve Screenshot').item;"
      },
      "typeVersion": 2
    },
    {
      "id": "05c57490-c1ee-48f0-9e38-244c9a995e22",
      "name": "Télécharger la capture d'écran de l'email vers Jira",
      "type": "n8n-nodes-base.jira",
      "position": [
        3860,
        480
      ],
      "parameters": {
        "issueKey": "={{ $('Create Jira Ticket').item.json.key }}",
        "resource": "issueAttachment"
      },
      "credentials": {
        "jiraSoftwareCloudApi": {
          "id": "BZmmGUrNIsgM9fDj",
          "name": "New Jira Cloud"
        }
      },
      "typeVersion": 1
    },
    {
      "id": "be02770d-a943-41f5-98a9-5c433a6a3dbf",
      "name": "Note adhésive",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1420,
        -107.36679523834897
      ],
      "parameters": {
        "color": 7,
        "width": 792.3026315789474,
        "height": 426.314163659402,
        "content": "![Gmail](https://uploads.n8n.io/templates/gmail.png)\n## Intégration Gmail et extraction de données\n\nCette section du workflow se connecte à un compte Gmail utilisant le **Déclencheur Gmail** nœud, capturant les emails entrants en temps réel, avec des vérifications effectuées toutes les minutes. Une fois qu'un email est détecté, ses composants clés—tels que le sujet, destinataire, corps, et enTetes—sont extraits et assignés à des variables utilisant le **Définir les variables Gmail** nœud. Ces variables sont structurées pour l'analyse et le traitement ultérieurs dans les étapes suivantes."
      },
      "typeVersion": 1
    },
    {
      "id": "c1d2f691-669a-46de-9ef8-59ce4e6980c5",
      "name": "Note adhésive1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1420,
        380.6918768014301
      ],
      "parameters": {
        "color": 7,
        "width": 792.3026315789474,
        "height": 532.3344389880435,
        "content": "![Gmail](https://uploads.n8n.io/templates/outlook.png)\n## Intégration Microsoft Outlook et traitement des en-têtes d'email\n\nCette section se connecte à un compte Microsoft Outlook pour surveiller les emails entrants utilisant le **Déclencheur Microsoft Outlook** nœud, qui vérifie les nouveaux messages toutes les minutes. Les emails sont ensuite traités pour récupérer les en-têtes détaillés et le contenu du corps via le **Récupérer les en-têtes de l'email** nœud. Les en-têtes sont structurés dans un format convivial utilisant le **Formater les en-têtes** code nœud, assurant la clarté pour une analyse ultérieure. Détails clés, incluant l'email sujet, destinataire, et le corps content, sont assignés à des variables avec le **Définir les variables Outlook** nœud pour une intégration simplifiée dans les étapes suivantes du workflow."
      },
      "typeVersion": 1
    },
    {
      "id": "c189e2e0-9f51-4bc0-a483-8b7f0528be70",
      "name": "Note adhésive2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2287.3684210526317,
        46.18421052631584
      ],
      "parameters": {
        "color": 7,
        "width": 580.4605263157906,
        "height": 615.460526315789,
        "content": "![hctiapi](https://uploads.n8n.io/templates/hctiapi.png)\n## Génération de capture d'écran HTML et visualisation d'email\n\nThis section processes an email’s HTML content pour créer une représentation visuelle, utile pour la documentation ou les workflows de détection de phishing. Le **Définir les variables Email** nœud organise le corps HTML de l'email dans un format prêt pour le traitement. Le **Capture d'écran HTML** nœud envoie ce contenu HTML vers le **hcti.io** API, qui génère une capture d'écran de la mise en page de l'email. Le **Récupérer la capture d'écran** nœud récupère ensuite l'URL de l'image pour une utilisation ultérieure dans le workflow. Cette configuration assure que l'apparence de l'email est préservée dans un format visuellement accessible, simplifiant l'examen et le rapport. Gardez à l'esprit cependant que cela expose le contenu de l'email à un tiers. Si vous hébergez n8n vous-même, vous pouvez déployer un outil cli pour pixelliser localement à la place."
      },
      "typeVersion": 1
    },
    {
      "id": "9076f9e9-f4fb-409a-9580-1ae459094c31",
      "name": "Note adhésive3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2880,
        123.72476075009968
      ],
      "parameters": {
        "color": 7,
        "width": 507.82894736842223,
        "height": 537.9199760920052,
        "content": "![hctiapi](https://uploads.n8n.io/templates/openai.png)\n## Analyse d'email alimentée par IA avec ChatGPT\n\nThis section exploite l'IA pour analyser le contenu des emails et les en-têtes pour les indicateurs de phishing. Le **Analyse ChatGPT** nœud utilise le modèle ChatGPT-4 pour examiner la capture d'écran de l'email et les métadonnées associées, incluant les en-têtes de message. Il génère un rapport détaillé indiquant si l'email pourrait être une tentative de phishing. La sortie est formatée spécifiquement pour Jira’s wiki-style renderer, la rendant prête pour une intégration transparente dans les workflows de ticketing. Cela assure une complète et automatisée évaluation des menaces par email."
      },
      "typeVersion": 1
    },
    {
      "id": "ca2488af-e787-4675-802a-8b4f2d845376",
      "name": "Note adhésive4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3400,
        122.88662032580646
      ],
      "parameters": {
        "color": 7,
        "width": 692.434210526317,
        "height": 529.5475902005091,
        "content": "![hctiapi](https://uploads.n8n.io/templates/jira.png)\n## Création automatique de tickets Jira pour les rapports de phishing\n\nThis section rationalise le processus de signalement des emails de phishing en créant automatiquement des tickets Jira détaillés. Le **Créer un ticket Jira** nœud compile les informations de l'email, incluant le sujet, destinataire, corps text, et l'analyse de phishing de ChatGPT, dans un ticket structuré. Le **Renommer la capture d'écran** nœud assure que le fichier de capture d'écran de l'email est correctement étiqueté pour l'attachement. Finalement, le **Télécharger la capture d'écran de l'email vers Jira** nœud attaches le email’s visual representation au ticket, fournissant un contexte supplémentaire pour l'équipe de sécurité. Cette intégration assure que les rapports de phishing sont enregistrés avec tous les détails nécessaires, permettant un suivi et une résolution efficaces."
      },
      "typeVersion": 1
    }
  ],
  "pinData": {},
  "connections": {
    "Déclencheur Gmail": {
      "main": [
        [
          {
            "node": "Définir les variables Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formater les en-têtes": {
      "main": [
        [
          {
            "node": "Définir les variables Outlook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture d'écran HTML": {
      "main": [
        [
          {
            "node": "Récupérer la capture d'écran",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse ChatGPT": {
      "main": [
        [
          {
            "node": "Créer un ticket Jira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Renommer la capture d'écran": {
      "main": [
        [
          {
            "node": "Télécharger la capture d'écran de l'email vers Jira",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Créer un ticket Jira": {
      "main": [
        [
          {
            "node": "Renommer la capture d'écran",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Récupérer la capture d'écran": {
      "main": [
        [
          {
            "node": "Analyse ChatGPT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Définir les variables Email": {
      "main": [
        [
          {
            "node": "Capture d'écran HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Définir les variables Gmail": {
      "main": [
        [
          {
            "node": "Définir les variables Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Définir les variables Outlook": {
      "main": [
        [
          {
            "node": "Définir les variables Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Déclencheur Microsoft Outlook": {
      "main": [
        [
          {
            "node": "Récupérer les en-têtes de l'email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Récupérer les en-têtes de l'email": {
      "main": [
        [
          {
            "node": "Formater les en-têtes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}